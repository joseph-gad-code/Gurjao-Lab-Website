{%- comment -%}
  authors_compact.html
  Usage:
    {% include authors_compact.html
         authors=p.authors
         max=20
         highlight_list=page.lab_names %}   <!-- list of names to bold -->
    # (still supports highlight='Gurjao' as a single string)
{%- endcomment -%}

{%- assign _raw = include.authors | default: '' | strip -%}
{%- if _raw == '' -%}{% comment %}No authors provided{% endcomment %}{%- endif -%}

{%- assign _sep_fixed = _raw
  | replace: ', and ', '|'
  | replace: ' and ', '|'
  | replace: ', ', '|'
-%}
{%- assign _names = _sep_fixed | split: '|' | uniq -%}

{%- assign _max = include.max | default: _names.size -%}

{%- for _raw_name in _names -%}
  {%- if forloop.index0 >= _max -%}
    et al.{% break %}
  {%- endif -%}

  {%- assign _name = _raw_name | strip -%}
  {%- assign _tokens = _name | split: ' ' -%}
  {%- assign _last = _tokens | last -%}
  {%- assign _firsts = '' -%}
  {%- if _tokens.size > 1 -%}
    {%- capture _firsts -%}
      {%- for t in _tokens offset:0 limit: {{ _tokens.size | minus: 1 }} -%}
        {%- assign _t = t | strip -%}
        {%- if _t != '' -%}{{ _t | slice: 0, 1 | upcase }}.{% if forloop.last == false %} {% endif %}{%- endif -%}
      {%- endfor -%}
    {%- endcapture -%}
  {%- endif -%}

  {%- assign _abbr = _firsts | append: ' ' | append: _last | strip -%}

  {%- assign _name_dn = _name | downcase -%}
  {%- assign _last_dn = _last | downcase -%}
  {%- assign _is_hl = false -%}

  {%- if include.highlight_list and include.highlight_list.size > 0 -%}
    {%- for h in include.highlight_list -%}
      {%- assign hdn = h | downcase | strip -%}
      {%- if hdn != '' and (_name_dn contains hdn or _last_dn == hdn) -%}
        {%- assign _is_hl = true -%}
      {%- endif -%}
    {%- endfor -%}
  {%- elsif include.highlight -%}
    {%- assign hdn = include.highlight | downcase | strip -%}
    {%- if hdn != '' and (_name_dn contains hdn or _last_dn == hdn) -%}
      {%- assign _is_hl = true -%}
    {%- endif -%}
  {%- endif -%}

  {%- if _is_hl -%}
    <strong class="author author--me">{{ _abbr }}</strong>
  {%- else -%}
    <span class="author">{{ _abbr }}</span>
  {%- endif -%}

  {%- unless forloop.last or forloop.index0+1 == _max -%}, {% endunless -%}
{%- endfor -%}
